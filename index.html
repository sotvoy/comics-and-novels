<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Comics & Novels ‚Äî Local Prototype (Fixed)</title>
<style>
:root{
  --bg:#0f1114; --surface:#181b1e; --card:#15181b; --muted:#9aa3ad; --accent:#1db954; --text:#e9eef2;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
/* Top bar */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:10px;position:sticky;top:0;background:var(--surface);z-index:40}
.left,.center,.right{display:flex;align-items:center;gap:8px}
button{background:none;border:none;color:inherit;font-size:15px;padding:6px;border-radius:8px;cursor:pointer}
.type-btn{padding:6px 8px;font-weight:700}
.tabs button{padding:6px 10px;border-radius:8px;background:transparent;color:var(--muted);font-weight:700}
.tabs button.active{color:var(--text);border-bottom:2px solid var(--accent)}
/* drawer */
.drawer{position:fixed;left:0;top:0;bottom:0;width:78%;max-width:320px;background:var(--card);transform:translateX(-110%);transition:transform .25s;padding:12px;z-index:60}
.drawer.open{transform:translateX(0)}
.drawer .item{padding:10px;border-radius:8px;cursor:pointer;color:var(--text);margin-bottom:6px}
/* main */
main{padding:14px;padding-bottom:140px}
.section{margin-bottom:18px}
.h-row{display:flex;gap:10px;overflow:auto;padding-bottom:6px}
.card{min-width:140px;background:linear-gradient(180deg,#111,#151515);border-radius:10px;flex:0 0 auto;padding:10px;color:var(--text)}
.card .cover{height:110px;background:#222;border-radius:8px;margin-bottom:8px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media(min-width:900px){.grid{grid-template-columns:repeat(3,1fr)}}

/* bottom nav */
.bottom-nav{position:fixed;left:0;right:0;bottom:0;background:var(--surface);padding:10px 8px;border-top:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:space-around;gap:6px;z-index:70}
.nav-btn{cursor:pointer;font-size:14px;color:var(--muted);background:none;border:none}
.plus{width:56px;height:56px;border-radius:50%;background:var(--accent);border:none;color:#061013;font-size:26px;display:flex;align-items:center;justify-content:center;margin-top:-28px;box-shadow:0 8px 24px rgba(0,0,0,0.6)}

/* modals */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:flex-end;justify-content:center;padding:12px;z-index:120}
.modal-backdrop.show{display:flex}
.modal{width:100%;max-width:920px;background:var(--card);border-radius:14px;padding:14px;color:var(--text)}
.btn{display:inline-block;padding:10px 12px;border-radius:10px;border:none;background:#222;color:#fff;cursor:pointer}
.input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:#0f1113;color:#fff}
.small{font-size:13px;color:var(--muted)}
.flex{display:flex;gap:8px;align-items:center}
.hidden{display:none}
.preview-img{height:90px;border-radius:6px;margin-right:8px}
.comment{padding:8px;border-top:1px solid rgba(255,255,255,0.03)}

/* toast */
#toast{position:fixed;right:12px;bottom:88px;background:#111;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);display:none;z-index:200;color:#fff}
</style>
</head>
<body>

<!-- TOAST -->
<div id="toast" role="status" aria-live="polite"></div>

<!-- Drawer -->
<div id="drawer" class="drawer" aria-hidden="true">
  <h4 style="margin:0 0 8px 0">Browse</h4>
  <div class="item" data-action="top">Top Ranking</div>
  <div class="item" data-action="new">New Uploads</div>
  <div class="item" data-action="genres">Genres</div>
  <div class="item" data-action="completed">Completed</div>
  <hr style="border:none;height:8px">
  <h4 style="margin:0 0 8px 0">Tools</h4>
  <div class="item" data-action="mylist">My List</div>
  <div class="item" data-action="playlists">Playlists</div>
  <div class="item" data-action="profile">My Profile</div>
</div>

<!-- Topbar -->
<div class="topbar">
  <div class="left">
    <button id="menuBtn" aria-label="Open menu">‚ò∞</button>
    <button id="genreBtn" class="type-btn" aria-label="Select category">Manhwa ‚ñæ</button>
  </div>

  <div class="center tabs" role="tablist" aria-label="Content tabs">
    <button id="tabComics" class="active" role="tab">Comics</button>
    <button id="tabNovels" role="tab">Novels</button>
  </div>

  <div class="right">
    <button id="notifBtn" title="Notifications" aria-label="Notifications">üîî</button>
    <button id="searchBtn" title="Search" aria-label="Search">üîç</button>
  </div>
</div>

<!-- App main -->
<main id="app" role="main" aria-live="polite"></main>

<!-- Bottom nav -->
<nav class="bottom-nav" role="navigation" aria-label="Main navigation">
  <button class="nav-btn" id="navHome">Home</button>
  <button class="nav-btn" id="navMyList">My List</button>
  <button id="plusBtn" class="plus" aria-label="Create">Ôºã</button>
  <button class="nav-btn" id="navFollowing">Following</button>
  <button class="nav-btn" id="navProfile">Profile</button>
</nav>

<!-- Create modal -->
<div id="createModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Create">
    <h3>Create</h3>
    <div class="flex" style="margin-bottom:12px">
      <button class="btn" id="openArtwork">üìò Publish Artwork</button>
      <button class="btn" id="openNovel">‚úçÔ∏è Publish Novel</button>
      <button class="btn" id="openPlaylist">üìÇ Create Playlist</button>
    </div>
    <div style="display:flex;justify-content:flex-end">
      <button class="btn" id="closeCreate">Close</button>
    </div>
  </div>
</div>

<!-- UPLOAD ARTWORK -->
<div id="uploadArtworkModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Publish Artwork">
    <h3>Publish Artwork (Comic / Webtoon)</h3>
    <div style="display:grid;gap:8px">
      <input id="artTitle" class="input" placeholder="Series title">
      <textarea id="artDesc" class="input" rows="2" placeholder="Short description"></textarea>
      <input id="artTags" class="input" placeholder="Tags (comma separated)">
      <select id="artLang" class="input"><option value="en">English</option><option value="ko">Korean</option><option value="bn">Bangla</option></select>
      <hr style="border:none;height:8px">
      <h4 style="margin:0">Add chapter</h4>
      <input id="chapterTitle" class="input" placeholder="Chapter title">
      <input id="chapterImages" class="input" type="file" accept="image/*" multiple>
      <div id="imagesPreview" style="display:flex;overflow:auto;margin-top:6px"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
        <button class="btn" id="saveArtChapter">Save Chapter</button>
        <button class="btn" id="publishArtBtn" style="background:var(--accent);color:#061013">Publish Series</button>
      </div>
      <div style="display:flex;justify-content:flex-end;margin-top:6px">
        <button class="btn" id="cancelUploadArt">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- UPLOAD NOVEL -->
<div id="uploadNovelModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Publish Novel">
    <h3>Publish Novel</h3>
    <div style="display:grid;gap:8px">
      <input id="novelTitle" class="input" placeholder="Novel title">
      <textarea id="novelDesc" class="input" rows="2" placeholder="Short description"></textarea>
      <input id="novelTags" class="input" placeholder="Tags (comma separated)">
      <hr style="border:none;height:8px">
      <h4 style="margin:0">Add chapter</h4>
      <input id="novelChapterTitle" class="input" placeholder="Chapter title">
      <textarea id="novelChapterContent" class="input" rows="8" placeholder="Write chapter here..."></textarea>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
        <button class="btn" id="saveNovelChapterBtn">Save Chapter</button>
        <button class="btn" id="publishNovelBtn" style="background:var(--accent);color:#061013">Publish Series</button>
      </div>
      <div style="display:flex;justify-content:flex-end;margin-top:6px">
        <button class="btn" id="cancelUploadNovel">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- PLAYLIST -->
<div id="playlistModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Create Playlist">
    <h3>Create Playlist</h3>
    <input id="playlistName" class="input" placeholder="Playlist name">
    <div style="display:flex;justify-content:flex-end;margin-top:8px">
      <button class="btn" id="savePlaylistBtn" style="background:var(--accent);color:#061013">Create</button>
      <button class="btn" id="closePlaylistBtn">Close</button>
    </div>
  </div>
</div>

<!-- READER -->
<div id="readerModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Reader" style="max-width:900px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <strong id="readerTitle"></strong>
        <div class="small" id="readerBy"></div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="readerFollowBtn">Follow</button>
        <button class="btn" id="readerLikeBtn">‚ù§Ô∏è <span id="readerLikeCount">0</span></button>
        <button class="btn" id="readerSaveBtn">‚òÜ Save</button>
      </div>
    </div>

    <div id="readerContentArea" style="margin-top:12px;max-height:60vh;overflow:auto"></div>

    <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
      <select id="chapterSelect" class="input" style="max-width:300px"></select>
      <button class="btn" id="prevChapterBtn">Prev</button>
      <button class="btn" id="nextChapterBtn">Next</button>
      <button class="btn" id="closeReaderBtn">Close</button>
    </div>

    <div style="margin-top:12px">
      <h4>Comments</h4>
      <div id="commentsList" style="max-height:160px;overflow:auto;border-radius:8px"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="commentInput" class="input" placeholder="Write a comment...">
        <button class="btn" id="sendCommentBtn">Send</button>
      </div>
    </div>
  </div>
</div>

<!-- AUTH -->
<div id="authModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Auth" style="max-width:420px">
    <h3 id="authTitle">Register / Login</h3>
    <div style="display:grid;gap:8px">
      <input id="regUsername" class="input" placeholder="Username">
      <input id="regEmail" class="input" placeholder="Email">
      <input id="regPassword" class="input" placeholder="Password" type="password">
      <div style="display:flex;gap:8px">
        <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="roleAuthor"> Author</label>
        <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="roleArtist"> Artist</label>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button class="btn" id="registerBtn">Register</button>
        <button class="btn" id="loginBtn">Login</button>
        <button class="btn" id="closeAuthBtn">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- NOTIFICATIONS -->
<div id="notifModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Notifications" style="max-width:420px">
    <h3>Notifications</h3>
    <div id="notifList" style="max-height:300px;overflow:auto"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn" id="closeNotifBtn">Close</button></div>
  </div>
</div>

<!-- SEARCH -->
<div id="searchModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Search" style="max-width:720px">
    <h3>Search</h3>
    <input id="searchInput" class="input" placeholder="Search series by title or tag">
    <div id="searchResults" style="margin-top:8px"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn" id="closeSearchBtn">Close</button></div>
  </div>
</div>

<script>
/*
  Complete, fixed local prototype script.
  - Handles corrupted localStorage gracefully
  - Avoids innerHTML for user content rendering
  - Hashes passwords via crypto.subtle.digest before storing (client-side)
  - Non-blocking toast instead of alert()
  - All DOM refs defined and used safely
*/

document.addEventListener('DOMContentLoaded', () => {

  /* ---------- Utilities ---------- */
  const STORAGE_KEY = 'cn_db_v2';
  function safeParse(key){
    try { return JSON.parse(localStorage.getItem(key)); }
    catch(e){ console.error('localStorage parse error', e); return null; }
  }
  function saveDB(db){ try { localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); } catch(e){ showToast('Storage error: quota?'); console.error(e); } }
  function uid(pref='id'){ return pref + '_' + Math.random().toString(36).slice(2,9); }
  function now(){ return new Date().toISOString(); }
  function showToast(msg, timeout=2600){
    const t = document.getElementById('toast'); t.textContent = msg; t.style.display='block';
    clearTimeout(t._to); t._to = setTimeout(()=> t.style.display='none', timeout);
  }
  async function hashPassword(str){
    const enc = new TextEncoder();
    const data = enc.encode(str);
    const hash = await crypto.subtle.digest('SHA-256', data);
    const arr = Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
    return arr;
  }
  // simple escape for rendering user content safely
  function escapeText(s){ if(!s) return ''; return String(s); /* we use textContent, so no HTML escapes required */ }

  /* ---------- DB init (safe) ---------- */
  let DB = safeParse(STORAGE_KEY);
  if(!DB || typeof DB !== 'object'){
    DB = { users:{}, series:{}, playlists:{}, notifications:{}, session:null };
    // seed demo user + series
    const demoId = uid('user');
    DB.users[demoId] = { id:demoId, username:'DemoAuthor', email:'demo@cn', passwordHash: null, roles:['author'], verified:true, followers:[], following:[], saved:[], history:{}, playlists:[], bio:'Demo creator' };
    const s1 = uid('series');
    DB.series[s1] = {
      id:s1, title:'Demo Manhwa', type:'comic', creatorId:demoId,
      description:'A demo manhwa produced locally for testing.',
      tags:['demo','manhwa'], language:'ko',
      chapters:[ { id:uid('ch'), title:'Chapter 1', contentType:'images', images:[], text:'', comments:[], stats:{views:0,likes:0}, publishedAt: now() } ],
      publishedAt: now(), stats:{views:1200,likes:30}
    };
    DB.session = { userId: demoId }; // auto-login demo (for convenience)
    saveDB(DB);
  }

  function currentUser(){ return DB && DB.session && DB.session.userId ? DB.users[DB.session.userId] : null; }
  function requireAuth(){ if(!currentUser()){ openAuth(); return false; } return true; }

  /* ---------- DOM refs ---------- */
  const drawer = document.getElementById('drawer'), menuBtn = document.getElementById('menuBtn'), genreBtn = document.getElementById('genreBtn');
  const tabComics = document.getElementById('tabComics'), tabNovels = document.getElementById('tabNovels');
  const notifBtn = document.getElementById('notifBtn'), searchBtn = document.getElementById('searchBtn'), app = document.getElementById('app');

  const plusBtn = document.getElementById('plusBtn'), createModal = document.getElementById('createModal'), openArtwork = document.getElementById('openArtwork');
  const openNovel = document.getElementById('openNovel'), openPlaylist = document.getElementById('openPlaylist'), closeCreate = document.getElementById('closeCreate');

  // Upload Artwork fields
  const uploadArtworkModal = document.getElementById('uploadArtworkModal');
  const artTitle = document.getElementById('artTitle'), artDesc = document.getElementById('artDesc'), artTags = document.getElementById('artTags'), artLang = document.getElementById('artLang');
  const chapterTitle = document.getElementById('chapterTitle'), chapterImages = document.getElementById('chapterImages'), imagesPreview = document.getElementById('imagesPreview');
  const saveArtChapter = document.getElementById('saveArtChapter'), publishArtBtn = document.getElementById('publishArtBtn'), cancelUploadArt = document.getElementById('cancelUploadArt');

  // Upload Novel fields
  const uploadNovelModal = document.getElementById('uploadNovelModal');
  const novelTitleInput = document.getElementById('novelTitle'), novelDesc = document.getElementById('novelDesc'), novelTags = document.getElementById('novelTags');
  const novelChapterTitle = document.getElementById('novelChapterTitle'), novelChapterContent = document.getElementById('novelChapterContent');
  const saveNovelChapterBtn = document.getElementById('saveNovelChapterBtn'), publishNovelBtn = document.getElementById('publishNovelBtn'), cancelUploadNovel = document.getElementById('cancelUploadNovel');

  // Playlist
  const playlistModal = document.getElementById('playlistModal'), playlistName = document.getElementById('playlistName'), savePlaylistBtn = document.getElementById('savePlaylistBtn'), closePlaylistBtn = document.getElementById('closePlaylistBtn');

  // Reader
  const readerModal = document.getElementById('readerModal'), readerTitle = document.getElementById('readerTitle'), readerBy = document.getElementById('readerBy');
  const readerContentArea = document.getElementById('readerContentArea'), chapterSelect = document.getElementById('chapterSelect');
  const prevChapterBtn = document.getElementById('prevChapterBtn'), nextChapterBtn = document.getElementById('nextChapterBtn'), closeReaderBtn = document.getElementById('closeReaderBtn');
  const readerFollowBtn = document.getElementById('readerFollowBtn'), readerLikeBtn = document.getElementById('readerLikeBtn'), readerLikeCount = document.getElementById('readerLikeCount');
  const readerSaveBtn = document.getElementById('readerSaveBtn'), commentsList = document.getElementById('commentsList'), commentInput = document.getElementById('commentInput'), sendCommentBtn = document.getElementById('sendCommentBtn');

  // Auth
  const authModal = document.getElementById('authModal'), regUsername = document.getElementById('regUsername'), regEmail = document.getElementById('regEmail');
  const regPassword = document.getElementById('regPassword'), roleAuthor = document.getElementById('roleAuthor'), roleArtist = document.getElementById('roleArtist');
  const registerBtn = document.getElementById('registerBtn'), loginBtn = document.getElementById('loginBtn'), closeAuthBtn = document.getElementById('closeAuthBtn');

  // Notif/Search
  const notifModal = document.getElementById('notifModal'), notifList = document.getElementById('notifList'), closeNotifBtn = document.getElementById('closeNotifBtn');
  const searchModal = document.getElementById('searchModal'), searchInput = document.getElementById('searchInput'), searchResults = document.getElementById('searchResults'), closeSearchBtn = document.getElementById('closeSearchBtn');

  /* ---------- Small helpers ---------- */
  function showModal(el){ el.classList.add('show'); el.setAttribute('aria-hidden','false'); }
  function hideModal(el){ el.classList.remove('show'); el.setAttribute('aria-hidden','true'); }

  /* ---------- Drawer & top controls ---------- */
  menuBtn.onclick = ()=> drawer.classList.toggle('open');

  drawer.querySelectorAll('.item').forEach(it => it.onclick = () => {
  const a = it.dataset.action;
  drawer.classList.remove('open');
  if(a === 'mylist') renderMyList();
  else if(a === 'playlists') renderPlaylists();
  else if(a === 'profile') renderProfile();
  else if(a === 'top') renderHome();
  else if(a === 'new') renderHome();
  else if(a === 'genres') showToast('Genres coming soon');
  else if(a === 'completed') showToast('Completed coming soon');
});
