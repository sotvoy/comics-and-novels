<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Comics & Novels ‚Äî C&N (Fixed)</title>

  <!-- Firebase SDKs (compat) - optional, can remain -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
    // Your Firebase config (optional, kept from earlier)
    const firebaseConfig = {
      apiKey: "AIzaSyCPp44zUE1rYsIpiiNq1DjRpXvJFA-zr4g",
      authDomain: "comics-and-novels.firebaseapp.com",
      projectId: "comics-and-novels",
      storageBucket: "comics-and-novels.firebasestorage.app",
      messagingSenderId: "438332137609",
      appId: "1:438332137609:web:1a6584ebcc4cc53224a658",
      measurementId: "G-2X748VJQ7K"
    };
    // initialize firebase safely (won't break if tokens invalid)
    try { firebase.initializeApp(firebaseConfig); } catch(e){ console.log('firebase init skipped or already initialized', e); }
    const fbAuth = firebase.auth ? firebase.auth() : null;
    const fbDB = firebase.firestore ? firebase.firestore() : null;
    const fbStorage = firebase.storage ? firebase.storage() : null;
  </script>

  <style>
    /* minimal critical CSS (keeps UI usable & consistent) */
    :root{ --bg:#0f1114; --card:#15181b; --muted:#9aa3ad; --accent:#1db954; --surface:#181b1e; --text:#e9eef2 }
    *{box-sizing:border-box} html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
    .topbar{display:flex;align-items:center;padding:10px 12px;background:var(--surface);gap:8px;position:sticky;top:0;z-index:40}
    .top-left{display:flex;align-items:center;gap:8px}
    .menu-btn,.type-btn,.icon{background:none;border:none;color:inherit;font-size:18px;padding:6px;border-radius:8px;cursor:pointer}
    .center-tabs{margin-left:auto;margin-right:12px;display:flex;gap:8px;align-items:center}
    .tab{background:none;border:none;color:var(--muted);padding:6px 8px;border-radius:8px;cursor:pointer}
    .tab.active{color:var(--text);border-bottom:2px solid var(--accent)}
    .drawer{position:fixed;left:0;top:0;bottom:0;width:78%;max-width:320px;background:var(--card);z-index:80;transform:translateX(-110%);transition:transform .25s;overflow:auto;padding:12px}
    .drawer.open{transform:translateX(0)}
    main{padding:14px;padding-bottom:120px}
    .h-row{display:flex;gap:10px;overflow:auto;padding-bottom:6px}
    .card{min-width:140px;height:190px;background:linear-gradient(180deg,#111,#151515);border-radius:10px;flex:0 0 auto;padding:10px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .bottom-nav{position:fixed;left:0;right:0;bottom:0;background:var(--surface);padding:10px 8px;border-top:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:space-around;gap:6px;z-index:60}
    .nav-btn{cursor:pointer;font-size:14px;color:var(--muted);background:none;border:none}
    .plus{width:56px;height:56px;border-radius:50%;background:var(--accent);border:none;color:#061013;font-size:26px;margin-top:-30px;display:flex;align-items:center;justify-content:center}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:flex-end;justify-content:center;padding:12px;z-index:120}
    .modal-backdrop.show{display:flex}
    .modal{width:100%;max-width:420px;background:var(--card);border-radius:14px;padding:14px}
    .btn{padding:10px 12px;border-radius:10px;background:#222;color:#fff;border:none}
    .input{width:100%;padding:10px;border-radius:8px;background:#0f1113;color:#fff;border:1px solid rgba(255,255,255,0.03)}
    .sm{font-size:13px;color:var(--muted)}
    .hidden{display:none}
    @media(min-width:900px){ .grid{grid-template-columns:repeat(3,1fr)} }
  </style>
</head>
<body>

  <!-- top -->
  <div class="topbar">
    <div class="top-left">
      <button class="menu-btn" id="openDrawer">‚ò∞</button>
      <button class="type-btn" id="genreBtn">Manhwa ‚ñæ</button>
    </div>
    <div class="center-tabs">
      <button class="tab active" id="tabComics">Comics</button>
      <button class="tab" id="tabNovels">Novels</button>
    </div>
    <div class="icons-right">
      <button class="icon" id="notifBtn">üîî</button>
      <button class="icon" id="searchBtn">üîç</button>
    </div>
  </div>

  <!-- drawer -->
  <div id="drawer" class="drawer" aria-hidden="true">
    <h4>Explore</h4>
    <div class="item" data-action="top">Top Ranking</div>
    <div class="item" data-action="new">New Uploads</div>
    <div class="item" data-action="genres">Genres</div>
    <div class="item" data-action="completed">Completed</div>
    <div style="height:14px"></div>
    <h4>Your Tools</h4>
    <div class="item" data-action="mylist">My List</div>
    <div class="item" data-action="playlists">Playlists</div>
    <div class="item" data-action="admin">Admin</div>
  </div>

  <!-- main -->
  <main id="app">
    <section class="section">
      <h3>Top 10 This Week</h3>
      <div class="h-row" id="top10"></div>
    </section>
    <section class="section">
      <div style="display:flex;gap:8px;overflow:auto;padding-bottom:6px" id="tagsRow"></div>
      <div id="tagsContent" style="margin-top:10px"></div>
    </section>
    <section class="section">
      <h3>All Content</h3>
      <div class="grid" id="feed"></div>
    </section>
  </main>

  <!-- bottom -->
  <nav class="bottom-nav">
    <button class="nav-btn" id="navHome">Home</button>
    <button class="nav-btn" id="navMyList">My List</button>
    <button id="plusBtn" class="plus">Ôºã</button>
    <button class="nav-btn" id="navFollowing">Following</button>
    <button class="nav-btn" id="navProfile">Profile</button>
  </nav>

  <!-- create modal -->
  <div id="createModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>Create</h3>
      <div style="display:flex;gap:8px;margin-bottom:10px">
        <button class="btn" id="createArtworkBtn">üìò Publish Artwork</button>
        <button class="btn" id="createNovelBtn">‚úçÔ∏è Publish Novel</button>
        <button class="btn" id="createPlaylistBtn">üìÇ Create Playlist</button>
      </div>
      <div style="display:flex;justify-content:flex-end">
        <button class="btn" id="closeCreate">Close</button>
      </div>
    </div>
  </div>

  <!-- upload artwork modal -->
  <div id="uploadArtwork" class="modal-backdrop" aria-hidden="true">
    <div class="modal">
      <h3>Publish Artwork</h3>
      <div class="form">
        <div class="field"><label class="sm">Title</label><input id="artTitle" class="input"></div>
        <div class="field"><label class="sm">Desc</label><textarea id="artDesc" class="input"></textarea></div>
        <div class="field"><label class="sm">Chapter title</label><input id="chapterTitle" class="input"></div>
        <div class="field"><label class="sm">Images</label><input id="chapterImages" type="file" accept="image/*" multiple class="input"></div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
          <button class="btn" id="saveChapter">Save Chapter</button>
          <button class="btn" id="publishArtwork" style="background:var(--accent);color:#061013">Publish</button>
        </div>
        <div id="artPreview" style="margin-top:10px"></div>
      </div>
      <div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn" id="cancelArtwork">Close</button></div>
    </div>
  </div>

  <!-- upload novel modal -->
  <div id="uploadNovel" class="modal-backdrop" aria-hidden="true">
    <div class="modal">
      <h3>Publish Novel</h3>
      <div class="form">
        <div class="field"><label class="sm">Title</label><input id="novelTitle" class="input"></div>
        <div class="field"><label class="sm">Chapter title</label><input id="novelChapterTitle" class="input"></div>
        <div class="field"><label class="sm">Content</label><textarea id="novelChapterContent" class="input" rows="8"></textarea></div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
          <button class="btn" id="saveNovelChapter">Save Chapter</button>
          <button class="btn" id="publishNovelSeries" style="background:var(--accent);color:#061013">Publish</button>
        </div>
        <div id="novelPreview" style="margin-top:10px"></div>
      </div>
      <div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn" id="cancelNovel">Close</button></div>
    </div>
  </div>

  <!-- auth modal simplified -->
  <div id="authModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal">
      <h3>Login / Register</h3>
      <div class="form">
        <div class="field"><input id="username" class="input" placeholder="username"></div>
        <div class="field"><input id="email" class="input" placeholder="email"></div>
        <div class="field"><input id="password" class="input" placeholder="password" type="password"></div>
        <div style="display:flex;justify-content:flex-end;gap:8px">
          <button class="btn" id="registerBtn">Register</button>
          <button class="btn" id="loginBtn">Login</button>
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn" id="closeAuth">Close</button></div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  try {
    // Minimal local DB
    const storage = {
      users: JSON.parse(localStorage.getItem('cn_users') || '{}'),
      series: JSON.parse(localStorage.getItem('cn_series') || '{}'),
      session: JSON.parse(localStorage.getItem('cn_session') || 'null')
    };
    function saveAll(){ localStorage.setItem('cn_users', JSON.stringify(storage.users)); localStorage.setItem('cn_series', JSON.stringify(storage.series)); localStorage.setItem('cn_session', JSON.stringify(storage.session)); }
    function uid(pref='id'){ return pref + '_' + Math.random().toString(36).slice(2,10); }
    function now(){ return new Date().toISOString(); }
    function currentUser(){ return storage.session && storage.session.userId ? storage.users[storage.session.userId] : null; }
    function showToast(m){ alert(m); }

    // seed demo if empty
    if(Object.keys(storage.users).length === 0){
      const u = uid('user'); storage.users[u] = { id:u, username:'Demo', email:'demo', roles:['author'], createdAt:now(), history:{} }; storage.session = { userId: u };
      const s = uid('series'); storage.series[s] = { id:s, title:'Demo Series', type:'comic', creatorId:u, chapters:[] }; saveAll();
    }

    // DOM refs (only once)
    const openDrawerBtn = document.getElementById('openDrawer');
    const drawer = document.getElementById('drawer');
    const genreBtn = document.getElementById('genreBtn');
    const tabComics = document.getElementById('tabComics');
    const tabNovels = document.getElementById('tabNovels');
    const notifBtn = document.getElementById('notifBtn');
    const searchBtn = document.getElementById('searchBtn');
    const top10El = document.getElementById('top10');
    const tagsRow = document.getElementById('tagsRow');
    const tagsContent = document.getElementById('tagsContent');
    const feedEl = document.getElementById('feed');

    const plusBtn = document.getElementById('plusBtn');
    const createModal = document.getElementById('createModal');
    const createArtworkBtn = document.getElementById('createArtworkBtn');
    const createNovelBtn = document.getElementById('createNovelBtn');
    const createPlaylistBtn = document.getElementById('createPlaylistBtn');
    const closeCreate = document.getElementById('closeCreate');

    const uploadArtwork = document.getElementById('uploadArtwork');
    const saveChapterBtn = document.getElementById('saveChapter');
    const publishArtworkBtn = document.getElementById('publishArtwork');
    const artPreview = document.getElementById('artPreview');
    const cancelArtwork = document.getElementById('cancelArtwork');

    const uploadNovel = document.getElementById('uploadNovel');
    const saveNovelChapterBtn = document.getElementById('saveNovelChapter');
    const publishNovelSeriesBtn = document.getElementById('publishNovelSeries');
    const novelPreview = document.getElementById('novelPreview');
    const cancelNovel = document.getElementById('cancelNovel');

    const authModal = document.getElementById('authModal');
    const registerBtn = document.getElementById('registerBtn');
    const loginBtn = document.getElementById('loginBtn');
    const closeAuth = document.getElementById('closeAuth');

    // helper show/hide modals
    function showModal(el){ el.classList.add('show'); el.setAttribute('aria-hidden','false'); }
    function hideModal(el){ el.classList.remove('show'); el.setAttribute('aria-hidden','true'); }

    // Drawer
    openDrawerBtn.onclick = ()=> drawer.classList.toggle('open');
    drawer.querySelectorAll('.item').forEach(it => it.onclick = ()=> { showToast('Clicked: '+it.dataset.action); drawer.classList.remove('open'); });

    // Genre picker
    genreBtn.onclick = ()=> { const choice = prompt('Choose: Manga, Manhwa, Manhua') || 'Manhwa'; genreBtn.textContent = choice + ' ‚ñæ'; };

    // Tabs
    tabComics.onclick = ()=> { tabComics.classList.add('active'); tabNovels.classList.remove('active'); rebuildFeed(); };
    tabNovels.onclick = ()=> { tabNovels.classList.add('active'); tabComics.classList.remove('active'); rebuildFeed(); };

    // plus -> create modal
    plusBtn.onclick = ()=> {
      if(!currentUser()){ showModal(authModal); return; }
      showModal(createModal);
    };
    closeCreate.onclick = ()=> hideModal(createModal);

    // create options
    createArtworkBtn.onclick = ()=> { hideModal(createModal); showModal(uploadArtwork); };
    createNovelBtn.onclick = ()=> { hideModal(createModal); showModal(uploadNovel); };
    createPlaylistBtn.onclick = ()=> { hideModal(createModal); showToast('Create Playlist - coming soon'); };

    // upload artwork flows (client-only previews)
    let artTemp = { chapters: [] };
    saveChapterBtn.onclick = async ()=>{
      const title = document.getElementById('chapterTitle').value || ('Ch ' + (artTemp.chapters.length+1));
      const files = document.getElementById('chapterImages').files;
      if(!files || files.length===0){ showToast('Pick images'); return; }
      const arr = [];
      for(const f of files){
        arr.push(await fileToBase64(f));
      }
      artTemp.chapters.push({ id: uid('ch'), title, images: arr, publishedAt: now() });
      renderArtPreview();
      document.getElementById('chapterTitle').value=''; document.getElementById('chapterImages').value='';
    };
    function renderArtPreview(){ artPreview.innerHTML = ''; artTemp.chapters.forEach(ch => { const d=document.createElement('div'); d.style.padding='8px'; d.innerHTML = `<strong>${ch.title}</strong><div style="display:flex;gap:6px;overflow:auto">${ch.images.map(i=>`<img src="${i}" style="height:70px;border-radius:6px">`).join('')}</div>`; artPreview.appendChild(d); }); }
    publishArtworkBtn.onclick = ()=>{
      const title = document.getElementById('artTitle').value || 'Untitled';
      const sid = uid('series');
      storage.series[sid] = { id:sid, title, type:'comic', creatorId: storage.session ? storage.session.userId : 'anon', chapters: artTemp.chapters.slice(), publishedAt: now() };
      artTemp = { chapters: [] }; saveAll(); hideModal(uploadArtwork); renderHome(); showToast('Published locally');
    };
    cancelArtwork.onclick = ()=> { artTemp = { chapters: [] }; hideModal(uploadArtwork); }

    // upload novel flows
    let novelTemp = { chapters: [] };
    saveNovelChapterBtn.onclick = ()=>{
      const t = document.getElementById('novelChapterTitle').value || ('Ch ' + (novelTemp.chapters.length+1));
      const txt = document.getElementById('novelChapterContent').value || '';
      novelTemp.chapters.push({ id: uid('ch'), title: t, text: txt, publishedAt: now() });
      renderNovelPreview();
      document.getElementById('novelChapterTitle').value=''; document.getElementById('novelChapterContent').value='';
    };
    function renderNovelPreview(){ novelPreview.innerHTML=''; novelTemp.chapters.forEach(ch=>{ const d=document.createElement('div'); d.style.padding='8px'; d.innerHTML=`<strong>${ch.title}</strong><div class="sm">${(ch.text||'').slice(0,150)}</div>`; novelPreview.appendChild(d); }); }
    publishNovelSeriesBtn.onclick = ()=>{
      const title = document.getElementById('novelTitle').value || 'Untitled';
      const sid = uid('series');
      storage.series[sid] = { id:sid, title, type:'novel', creatorId: storage.session ? storage.session.userId : 'anon', chapters: novelTemp.chapters.slice(), publishedAt: now() };
      novelTemp = { chapters: [] }; saveAll(); hideModal(uploadNovel); renderHome(); showToast('Novel published (local)');
    };
    cancelNovel.onclick = ()=> { novelTemp = { chapters: [] }; hideModal(uploadNovel); }

    // auth modal hooks (very simple local/fb combo)
    registerBtn.onclick = async ()=>{
      const username = document.getElementById('username').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      if(!username || !email || !password){ showToast('fill fields'); return; }
      try{
        // try firebase create, but fallback to local if not available
        let uidCreated = uid('user');
        if(fbAuth && fbDB){
          const uc = await fbAuth.createUserWithEmailAndPassword(email,password);
          uidCreated = uc.user.uid;
          await fbDB.collection('users').doc(uidCreated).set({ id:uidCreated, username, email, createdAt: now() });
        }
        storage.users[uidCreated] = { id:uidCreated, username, email };
        storage.session = { userId: uidCreated };
        saveAll(); hideModal(authModal); renderProfile(); showToast('Registered & logged in');
      }catch(err){ console.error(err); showToast('Register error: '+(err.message||err)); }
    };
    loginBtn.onclick = async ()=>{
      const usernameOrEmail = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      if(!usernameOrEmail || !password){ showToast('fill'); return; }
      try{
        // try firebase sign in
        if(fbAuth && fbDB){
          let email = usernameOrEmail;
          if(!usernameOrEmail.includes('@')){
            const q = await fbDB.collection('users').where('username','==',usernameOrEmail).limit(1).get();
            if(!q.empty) email = q.docs[0].data().email;
          }
          const uc = await fbAuth.signInWithEmailAndPassword(email,password);
          const uid = uc.user.uid;
          const doc = await fbDB.collection('users').doc(uid).get();
          storage.users[uid] = doc.exists ? doc.data() : { id:uid, username:email, email };
          storage.session = { userId: uid }; saveAll(); hideModal(authModal); renderProfile(); showToast('Logged in (firebase)');
          return;
        }
        // fallback: local auth (username must match)
        const found = Object.values(storage.users).find(u=> u.username === usernameOrEmail || u.email === usernameOrEmail);
        if(found){ storage.session = { userId: found.id }; saveAll(); hideModal(authModal); renderProfile(); showToast('Logged in (local)'); }
        else showToast('User not found (local)');
      }catch(err){ console.error(err); showToast('Login error: '+(err.message||err)); }
    };
    closeAuth.onclick = ()=> hideModal(authModal);

    // render functions
    function buildTo
